{% extends 'base.html' %}
{% load static %}

{% block content %}
<section class="search-results-section" style="padding: 40px 0;">
    <div class="section-header">
        <h2 class="section-title">Search Results</h2>
        {% if search_query or request.GET.category or request.GET.status or request.GET.min_price or request.GET.max_price %}
        <div class="active-filters" style="margin-top: 10px; font-size: 14px; color: var(--text-light);">
            Showing results for:
            {% if search_query %}<strong>"{{ search_query }}"</strong>{% endif %}
            {% if selected_category %} in <strong>{{ selected_category.title }}</strong>{% endif %}
            {% if request.GET.status %} (Status: <strong>{{ request.GET.status }}</strong>){% endif %}
            {% if request.GET.min_price %} (Min: <strong>${{ request.GET.min_price }}</strong>){% endif %}
            {% if request.GET.max_price %} (Max: <strong>${{ request.GET.max_price }}</strong>){% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Filter Section -->
    <section class="filters-section" style="margin-bottom: 2rem;">
        <form method="GET" action="{% url 'search_results' %}" class="filters-form">
            <input type="hidden" name="q" value="{{ search_query }}">
            
            <div class="filter-group">
                <label for="category">Category:</label>
                <select name="category" id="category" onchange="this.form.submit()">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                        <option value="{{ category.pk }}" {% if request.GET.category == category.pk|stringformat:"i" %}selected{% endif %}>{{ category.title }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="status">Status:</label>
                <select name="status" id="status" onchange="this.form.submit()">
                    <option value="">All Status</option>
                    <option value="NW" {% if request.GET.status == 'NW' %}selected{% endif %}>New</option>
                    <option value="US" {% if request.GET.status == 'US' %}selected{% endif %}>Used</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="min_price">Min Price:</label>
                <input type="number" name="min_price" id="min_price" value="{{ request.GET.min_price }}" placeholder="Min" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; width: 80px;">
            </div>

            <div class="filter-group">
                <label for="max_price">Max Price:</label>
                <input type="number" name="max_price" id="max_price" value="{{ request.GET.max_price }}" placeholder="Max" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; width: 80px;">
            </div>

            <div class="filter-group">
                <label for="sort">Sort by:</label>
                <select name="sort" id="sort" onchange="this.form.submit()">
                    <option value="">Latest</option>
                    <option value="price_asc" {% if request.GET.sort == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
                    <option value="price_desc" {% if request.GET.sort == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
                </select>
            </div>

            <button type="submit" class="btn-confirm" style="padding: 8px 15px; margin-bottom: 0;">Apply</button>
            <a href="{% url 'search_results' %}?q={{ search_query }}" class="btn-reset">Reset</a>
        </form>
    </section>

    {% if posts %}
    <div class="product-grid">
        {% for post in posts %}
        <div class="product-card">
            <div class="discount-badge">{{ post.discount }}% OFF</div>
            <div class="product-image">
                {% if post.images.first %}
                    <img src="{{ post.images.first.image.url }}" alt="{{ post.title }}">
                {% elif post.image %}
                     <img src="{{ post.image.url }}" alt="{{ post.title }}">
                {% else %}
                    <div style="width:100%; height:100%; background:#eee; display:flex; align-items:center; justify-content:center; color:#999;">No Image</div>
                {% endif %}
            </div>
            <div class="product-info">
                <h3 class="product-title">{{ post.title }}</h3>
                <div class="product-price">
                    ${{ post.price|default:"0.00" }}
                </div>
                <div class="product-action" style="margin-top: 10px;">
                    <a href="{% url 'post_detail' post.pk %}" style="display: block; text-align: center; width: 100%; padding: 8px; background-color: var(--secondary-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; text-decoration: none; margin-bottom: 5px;">
                        View Details
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; color: var(--text-light);">
        <h3>No results found.</h3>
        <p>Try adjusting your search terms or filters.</p>
    </div>
    {% endif %}
</section>
{% endblock content %}
